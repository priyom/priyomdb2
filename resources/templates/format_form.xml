<?xml version="1.0"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tea="https://xmlns.zombofant.net/xsltea/processors"
      xmlns:exec="https://xmlns.zombofant.net/xsltea/exec"
      xmlns:sitemap="https://xmlns.zombofant.net/xsltea/sitemap"
      xmlns:form="https://xmlns.zombofant.net/xsltea/form"
      xmlns:i18n="https://xmlns.zombofant.net/xsltea/i18n">
  <head>
    <title><i18n:_>Edit format</i18n:_></title>
    <tea:include src="stylesheets.xml"
                 xpath="h:link"
                 nsmap="{'h': 'http://www.w3.org/1999/xhtml'}"/>
  </head>

  <tea:def name="minmax">
    <tea:arg name="default_form" mode="lazy" default="default_form" />
    <tea:arg name="node" mode="lazy" default="node" />
    <label form:for-field="nmin"><i18n:_>Minimum repeat: </i18n:_></label>
    <input form:field="nmin"
           i18n:title="Minimum character count"/>
    <label form:for-field="nmax"><i18n:_>Maximum repeat: </i18n:_></label>
    <input form:field="nmax"
           i18n:title="Maximum character count"
           placeholder="+∞"/>
  </tea:def>

  <tea:def name="common_controls_header">
    <tea:arg name="default_form" mode="lazy" default="default_form" />
    <tea:arg name="node" mode="lazy" default="node" />
    <tea:switch>
      <tea:case exec:eval="(node.index or 0) > 0">
        <button form:action="move_up"
                class="ym-button ym-small ym-up">
          <i18n:_>Move up</i18n:_>
        </button>
      </tea:case>
      <tea:default />
    </tea:switch>
  </tea:def>

  <tea:def name="common_controls_footer">
    <tea:arg name="default_form" mode="lazy" default="default_form" />
    <tea:arg name="node" mode="lazy" default="node" />
    <tea:if exec:eval="node.parent and
                       (len(node.parent) - 1) &gt; node.index ">
      <button form:action="move_down"
              class="ym-button ym-small ym-down">
        <i18n:_>Move down</i18n:_>
      </button>
    </tea:if>
    <tea:if exec:eval="node.parent">
      <button form:action="delete"
              class="ym-button ym-small ym-delete">
        <i18n:_>Delete</i18n:_>
      </button>
    </tea:if>
  </tea:def>

  <tea:def name="inserter_controls">
    <tea:arg name="default_form" mode="lazy" default="default_form" />
    <tea:arg name="node" mode="lazy" default="node" />
    <button form:action="insert_structure"
            class="ym-button ym-small ym-add">
      <i18n:_>Insert structure node</i18n:_>
    </button>
    <button form:action="insert_simple_content"
            class="ym-button ym-small ym-add">
      <i18n:_>Insert simple content node</i18n:_>
    </button>
  </tea:def>

  <tea:def name="appender_controls">
    <tea:arg name="default_form" mode="lazy" default="default_form" />
    <tea:arg name="node" mode="lazy" default="node" />
    <button form:action="add_structure"
            class="ym-button ym-small ym-add">
      <i18n:_>Add structure node</i18n:_>
    </button>
    <button form:action="add_simple_content"
            class="ym-button ym-small ym-add">
      <i18n:_>Add simple content node</i18n:_>
    </button>
  </tea:def>

  <tea:def name="simple_content_node">
    <tea:arg name="node" />
    <div form:form="node" class="fmt-node fmt-leaf">
      <div class="fmt-node-header">
        <span class="fmt-node-title"><i18n:_>Simple content</i18n:_></span>
        <tea:call name="common_controls_header" />
      </div>
      <div class="fmt-leaf-controls0">
        <label form:for-field="kind">
          <i18n:_>Kind: </i18n:_>
        </label>
        <select form:field="kind"
                i18n:title="Type of content"/>
      </div>
      <div class="fmt-leaf-controls1">
        <tea:call name="minmax" />
      </div>
      <div class="fmt-node-footer">
        <tea:call name="common_controls_footer" />
      </div>
    </div>
  </tea:def>

  <tea:def name="structure_node">
    <tea:arg name="node" />
    <div form:form="node" class="fmt-node fmt-struct">
      <div class="fmt-node-header">
        <span class="fmt-node-title"><i18n:_>Structure</i18n:_></span>
        <tea:call name="common_controls_header" />
      </div>
      <div class="fmt-struct-outer-controls">
        <tea:call name="minmax" />
        <span><i18n:_>Join: </i18n:_></span>
        <input form:field="joiner_regex"
               i18n:placeholder="regex"/>
        <input form:field="joiner_const"
               i18n:placeholder="const"/>
      </div>
      <div class="fmt-struct-inner-box">
        <div class="fmt-struct-inner-controls">
          <label form:for-field="save_to">
            <i18n:_>Save into DB as: </i18n:_>
          </label>
          <input form:field="save_to"
                 i18n:placeholder="unique name"
                 i18n:title="Name for saving an entry"/>
        </div>
        <div class="fmt-struct-children">
          <tea:call name="inserter_controls" />
          <tea:for-each bind="child" from="node.children">
            <tea:switch>
              <tea:case exec:eval="child.type_ == 'srct'">
                <tea:call name="structure_node">
                  <tea:pass name="node">child</tea:pass>
                </tea:call>
              </tea:case>
              <tea:case exec:eval="child.type_ == 'sicn'">
                <tea:call name="simple_content_node">
                  <tea:pass name="node">child</tea:pass>
                </tea:call>
              </tea:case>
              <tea:default>error</tea:default>
            </tea:switch>
          </tea:for-each>
          <tea:call name="appender_controls" />
        </div>
      </div>
      <div class="fmt-node-footer">
        <tea:call name="common_controls_footer" />
      </div>
    </div>
  </tea:def>

  <body>
    <exec:code>form = arguments['form']</exec:code>
    <tea:include src="aux.xml" xpath="/misc/*" />
    <main>
      <h2><i18n:_>Edit transmission format</i18n:_></h2>
      <tea:if exec:eval="arguments['has_users']">
        <p class="box warning">
          <strong><i18n:_>Warning:</i18n:_></strong>
          <i18n:_>This format has users. This implies that you cannot modify
          it. You can, however, save a copy of the format.</i18n:_>
        </p>
      </tea:if>
      <form class="ym-form" method="POST" name="format" form:form="form">
        <h6 class="ym-fbox-heading">General properties</h6>
        <div class="ym-fbox">
          <label form:for-field="display_name">Display name</label>
          <input form:field="display_name"
                 placeholder="e.g. S28 default format"/>
        </div>
        <div class="ym-fbox">
          <label form:for-field="description">Description</label>
          <textarea form:field="description" />
        </div>
        <p class="ym-fbox-footer warning">
          <strong xml:space="preserve"><i18n:_>Warning:</i18n:_> </strong>
          <i18n:_>Until you click “Save to database” below,
          <em i18n:id="em">no</em> changes are made to the entries in the
          database. Leaving the page without saving will make you lose all your
          changes!</i18n:_>
        </p>
        <div class="ym-fbox-footer ym-fbox-button">
          <button type="submit"
                  form:action="update"
                  class="ym-button ym-reload">
            <i18n:_>Update / Check for errors</i18n:_>
          </button>
        </div>
        <h6 class="ym-fbox-heading"><i18n:_>Parser configuration</i18n:_></h6>
        <div class="fmt-root">
          <tea:call name="structure_node">
            <tea:pass name="node">form</tea:pass>
          </tea:call>
        </div>
        <div class="ym-fbox-footer ym-fbox-button">
          <tea:if exec:eval="not arguments['has_users']">
            <button type="submit"
                    form:action="save_to_db"
                    class="ym-button ym-primary ym-save">
              <i18n:_>Save to database</i18n:_>
            </button>
          </tea:if>
          <button type="submit"
                  form:action="save_copy"
                  class="ym-button ym-add">
            <i18n:_>Save as copy</i18n:_>
          </button>
        </div>
      </form>
    </main>
  </body>
</html>
