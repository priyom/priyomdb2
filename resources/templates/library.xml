<?xml version="1.0"?>
<library
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:tea="https://xmlns.zombofant.net/xsltea/processors"
    xmlns:form="https://xmlns.zombofant.net/xsltea/form"
    xmlns:exec="https://xmlns.zombofant.net/xsltea/exec">
  <tea:def tea:name="page">
    <tea:arg name="page" mode="lazy" default="page" />
    <tea:arg name="view" mode="lazy" default="view" />
    <tea:arg name="pageno" mode="lazy" default="pageno" />
    <li exec:class="'current' if page.get_pageno() == pageno else None">
      <a exec:href="href(view, view=page.at_page(pageno))"><exec:text>pageno</exec:text></a>
    </li>
  </tea:def>
  <tea:def tea:name="pagination">
    <tea:arg name="page" />
    <tea:arg name="view" />
    <exec:code>total_pages = page.total_pages</exec:code>
    <exec:code>
def calculate_range(start_at, end_at):
    skip_before, skip_after = True, True
    if start_at &lt;= 3:
        skip_before = False
        start_at = 2
    if end_at &gt;= page.total_pages - 2:
        skip_after = False
        end_at = page.total_pages - 1
    return skip_before, skip_after, start_at, end_at
start_at = page.get_pageno() - 2
end_at = page.get_pageno() + 2
skip_before, skip_after, start_at, end_at = calculate_range(start_at, end_at)
if skip_before and not skip_after:
    start_at = end_at - 5
    skip_before, skip_after, start_at, end_at = calculate_range(start_at, end_at)
elif skip_after and not skip_before:
    end_at = start_at + 5
    skip_before, skip_after, start_at, end_at = calculate_range(start_at, end_at)
pagerange = range(start_at, end_at+1)</exec:code>
    <ul class="pagination">
      <exec:if condition="page.get_pageno() &gt; 1">
        <li class="wide">
          <a exec:href="href(view, view=page.at_page(page.get_pageno()-1))">« prev</a>
        </li>
      </exec:if>
      <tea:call tea:name="page">
        <tea:pass name="pageno">1</tea:pass>
      </tea:call>
      <exec:if condition="skip_before">
        <li><div class="fakebutton">…</div></li>
      </exec:if>
      <tea:for-each tea:bind="pageno" tea:from="pagerange">
        <tea:call tea:name="page" />
      </tea:for-each>
      <exec:if condition="skip_after">
        <li><div class="fakebutton">…</div></li>
      </exec:if>
      <exec:if condition="page.total_pages &gt; 1">
        <tea:call tea:name="page">
          <tea:pass name="pageno">total_pages</tea:pass>
        </tea:call>
      </exec:if>
      <exec:if condition="page.get_pageno() &lt; page.total_pages">
        <li class="wide">
          <a exec:href="href(view, view=page.at_page(page.get_pageno()+1))">next »</a>
        </li>
      </exec:if>
    </ul>
  </tea:def>
  <tea:def tea:name="filters">
    <tea:arg name="page" />
    <tea:arg name="view" />
    <exec:code>filters = page.f</exec:code>
    <ul>
      <tea:for-each tea:bind="row" tea:from="filters">
        <li>
          <exec:text>row.f</exec:text>
          <exec:text>' '</exec:text>
          <exec:text>row.o</exec:text>
          <exec:text>' '</exec:text>
          <exec:text>repr(row.v)</exec:text>
        </li>
      </tea:for-each>
    </ul>
    <a class="ym-button ym-warning ym-delete"
       exec:href="href(view, view=page.without_filters())">Clear all filters</a>
  </tea:def>
  <tea:def tea:name="errors">
    <tea:arg name="form" mode="lazy" default="default_form" />
    <tea:arg name="field" />
    <exec:code>field = getattr(type(form), field) if field is not None and field != 'None' else None
errors = form.errors.get(field, [])</exec:code>
    <exec:if condition="errors">
      <div class="ym-fbox">
        <div class="form-errors">
          <ul>
            <tea:for-each tea:bind="error" tea:from="errors">
              <li><exec:text>error.err</exec:text></li>
            </tea:for-each>
          </ul>
        </div>
      </div>
    </exec:if>
  </tea:def>
  <tea:def tea:name="event_contents">
    <tea:arg name="event" mode="lazy" default="event" />
    <exec:code>rows = event.contents</exec:code>
    <tea:for-each tea:bind="row" tea:from="rows">
      <exec:if condition="row.parent_contents is None">
        <div><exec:text>row</exec:text></div>
      </exec:if>
    </tea:for-each>
  </tea:def>
  <tea:def tea:name="frequency_list_input">
    <tea:arg name="default_form" mode="lazy" default="default_form" />
    <tea:arg name="rows" />
    <tea:arg name="existing_frequencies" />
    <tea:arg name="modes" mode="lazy" default="modes" />
    <table>
      <colgroup>
        <col />
        <col />
        <col class="actions" style="width: 15em" />
      </colgroup>
      <thead>
        <th>Frequency</th>
        <th>Mode and Mode</th>
        <th>Actions</th>
      </thead>
      <tbody>
        <tea:for-each tea:bind="row" tea:from="rows">
          <tr form:form="row">
            <td>
              <div class="ym-fbox">
                <input type="text"
                       form:field="frequency" />
              </div>
              <tea:call tea:name="errors">
                <tea:pass name="field">'frequency'</tea:pass>
              </tea:call>
            </td>
            <td>
              <div class="ym-fbox">
                <select form:field="mode_id">
                  <tea:for-each tea:bind="mode"
                                tea:from="modes">
                    <option exec:value="mode.id"
                            exec:selected="'selected' if mode.id == row.mode_id else None">
                      <exec:text>mode</exec:text>
                    </option>
                  </tea:for-each>
                </select>
              </div>
            </td>
            <td>
              <div class="ym-fbox">
                <button type="submit"
                        form:action="delete"
                        class="ym-button ym-delete ym-warning">Delete</button>
              </div>
            </td>
          </tr>
        </tea:for-each>
        <tr>
          <td colspan="3">
            <div class="ym-fbox">
              <label form:for-field="existing_broadcast_frequency_id">
                Add another frequency
              </label>
              <select form:field="existing_broadcast_frequency_id">
                <option value="0">Select known frequency or hit add to
                create a new one</option>
                <tea:for-each tea:bind="event_frequency"
                              tea:from="existing_frequencies">
                  <option exec:value="event_frequency.id">
                    <exec:text>event_frequency</exec:text>
                  </option>
                </tea:for-each>
              </select>
            </div>
            <div class="ym-fbox">
              <button type="submit"
                      form:action="add_frequency"
                      class="ym-button ym-add">Add new</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </tea:def>
  <tea:def tea:name="transcriptdata">
    <tea:arg name="row" mode="lazy" default="row" />
    <tea:arg name="alphabets" mode="lazy" default="alphabets" />
    <div class="ym-fbox" form:form="row">
      <label form:for-field="alphabet_id">Alphabet</label>
      <select form:field="alphabet_id">
        <tea:for-each tea:bind="alphabet" tea:from="alphabets">
          <option exec:value="alphabet.id"
                  exec:selected="'selected' if row.alphabet_id == alphabet.id else None">
            <exec:text>alphabet.display_name</exec:text>
          </option>
        </tea:for-each>
      </select>
    </div>
    <div class="ym-fbox" form:form="row">
      <label form:for-field="contents">Contents</label>
      <textarea form:field="contents"
                rows="10"
                class="transmission"/>
    </div>
  </tea:def>
  <tea:def tea:name="transcriptmetadata">
    <tea:arg name="row" mode="lazy" default="row" />
    <div class="ym-fbox" form:form="row">
      <label form:for-field="attribution">Attribution</label>
      <textarea form:field="attribution" />
    </div>
  </tea:def>
  <tea:def tea:name="contents_list_input">
    <tea:arg name="default_form" mode="lazy" default="default_form" />
    <tea:arg name="rows" />
    <tea:arg name="alphabets" mode="lazy" default="alphabets" />
    <tea:arg name="formats" mode="lazy" default="formats" />
    <table>
      <colgroup>
        <col width="66%" />
        <col width="33%" />
      </colgroup>
      <thead>
        <th>Contents</th>
        <th>Actions and Metadata</th>
      </thead>
      <tbody>
        <tea:for-each tea:bind="row" tea:from="rows">
          <tr form:form="row">
            <td>
              <div class="ym-fbox">
                <label form:for-field="format_id">Format</label>
                <select form:field="format_id">
                  <tea:for-each tea:bind="format" tea:from="formats">
                    <option exec:value="format.id"
                            exec:selected="'selected' if row.format_id == format.id else None">
                      <exec:text>format.display_name</exec:text>
                    </option>
                  </tea:for-each>
                </select>
              </div>
              <tea:call tea:name="transcriptdata" />
            </td>
            <td>
              <h6 class="ym-fbox-heading">Metadata</h6>
              <tea:call tea:name="transcriptmetadata" />
              <h6 class="ym-fbox-heading">Actions</h6>
              <div class="ym-fbox ym-fbox-button">
                <button type="submit"
                        form:action="add_transcript"
                        class="ym-button ym-add">Add transcript</button>
              </div>
              <div class="ym-fbox ym-fbox-button">
                <button type="submit"
                        form:action="delete"
                        class="ym-button ym-delete ym-warning">Delete</button>
              </div>
            </td>
          </tr>
          <exec:code>transcripts = row.transcripts</exec:code>
          <tea:for-each tea:bind="subrow" tea:from="transcripts">
            <tr form:form="subrow">
              <td>
                <h6 class="ym-fbox-heading">Transcript</h6>
                <tea:call tea:name="transcriptdata">
                  <tea:pass name="row">subrow</tea:pass>
                </tea:call>
              </td>
              <td>
                <h6 class="ym-fbox-heading">Transcript metadata</h6>
                <tea:call tea:name="transcriptmetadata">
                  <tea:pass name="row">subrow</tea:pass>
                </tea:call>
                <h6 class="ym-fbox-heading">Transcript actions</h6>
                <div class="ym-fbox ym-fbox-button">
                  <button type="submit"
                          form:action="delete"
                          class="ym-button ym-delete ym-warning">Delete transcript</button>
                </div>
              </td>
            </tr>
          </tea:for-each>
        </tea:for-each>
        <tr>
          <td />
          <td>
            <div class="ym-fbox">
              <button type="submit"
                      form:action="add_contents"
                      class="ym-button ym-add">Add another transmission</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </tea:def>
</library>
